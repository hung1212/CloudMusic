<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>网易云音乐 API</title>
  <script src="./js/lib/vue.js"></script>
  <script src="./js/lib/jquery.js"></script>
  <style>
    * {
      padding: 0;
      margin: 0;
      box-sizing: border-box;
    }

    .box {
      display: flex;
    }

    li {
      list-style-type: none;
    }
    .tatolpage,.tatolpage ul {
      display: flex;
    }

    .tatolpage ul li {
      list-style-type: none;
      width: 34px;
      height: 34px;
      cursor: pointer;
      border: 1px solid #eee;
      text-align: center;
    }
    .tatolpage ul li.current {
      background: skyblue;
    }

    .slyric {
      border: 1px solid #eee;
    }
    .songslrc {
      /* border: 1px solid red; */
    }

    .red {
      color: red;
    }
  </style>
</head>

<body>
  <div id="app">
    !!!!
    <div class="box">
      <div class="app-left">
        <button @click="reload">刷新</button><br />
        <input type="text" v-model:value="searchKeyword">
        <button @click="serch">ok</button>
        <audio @timeupdate="audio" ref="musicAudio" :src="songsInfo.url" controls autoplay loop style="display:none">
          你的浏览器不支持audio标签
        </audio>
        <div>
          <ul>
            <li v-for="item in songs" :key="item.id">
              {{ item.name }}
              <button @click="getSongsUrl(item.id)">播放</button>
            </li>
          </ul>
        </div>


        <!-- 页面 -->
        <div class="tatolpage" style="display:none" ref="showPage">
          <button @click="tabPage(1)">首页</button>
          <button @click="tabPage(currentPage-1)">上一页</button>
          <ul>

            <template v-for="item in songCountPage">
              <!-- <li v-if="item + 5 > currentPage && currentPage + 5 > item"
                       @click="tabPage(item)"
                       :class="{ current: item === currentPage }"
                      >{{ item }} </li> -->
              <li v-if="item >= viewPage.start && item <= viewPage.end" @click="tabPage(item)" :class="{ current: item === currentPage }">{{
                item }} </li>
            </template>
          </ul>
          <button @click="tabPage(currentPage+1)">下一页</button>
          <button @click="tabPage(songCountPage)">尾页</button>
        </div>

        <!-- 显示歌曲的歌词 -->
        <div class="slyric">
          <p>{{ currentLrc.lrc }}</p>
        </div>
      </div>

      <div class="songslrc">
        <ul>
          <template v-for="(item,index) in songsLrc">
            <li :class="{red: item.time < audioTime && currentLrc.index == index}">{{ item.lrc }}</li>
          </template>
        </ul>
      </div>
    </div>
  </div>

</body>
<script>
  new Vue(
    {
      el: '#app',
      data: {
        searchKeyword: "五月天",
        songs: [],//歌曲
        songsInfo: [],//歌曲信息
        limit: 10,//每页显示多少首歌
        currentPage: 1,//当前显示的页数
        songCountPage: 1,//一共有多少页(页数-1)*limit
        songsLrc: [],//获取歌曲的歌词
        currentLrc: {},//当前渲染的歌词
        audioTime: 0,//储存进度条的时间
      },
      computed: {
        viewPage() {
          let start = 0;
          let end = 0;
          start = this.currentPage - 3
          end = this.currentPage + 3
          if (start < 1) {
            end += 1 - start
          }
          if (end > this.songCountPage) {
            start -= end - this.songCountPage
          }
          // console.log('start:' + start)
          // console.log('end:' + end)
          // console.log('当前页数:' + this.currentPage)
          return {
            start,
            end,
          }
        }
      },
      methods: {
        //刷新页面
        reload() {
          location.href = location.pathname + "?" + Date.now();
        },

        //搜索
        serch() {
          $.get('/search', { keywords: this.searchKeyword, limit: this.limit, offset: (this.currentPage - 1) * this.limit }, function (res) {
            this.songs = res.result.songs
            //拿到总页数
            this.songCountPage = Math.ceil(res.result.songCount / this.limit);
            this.$refs.showPage.style.display = "flex";
            this.$refs.musicAudio.style.display = "block";
            //console.log(res);
            //console.log(this.songCountPage);
          }.bind(this))
        },

        //点击播放
        getSongsUrl: function (id) {
          this.$refs.musicAudio.src = "";
          $.get('/song/url', { id: id }, (res) => {
            this.songsInfo = res.data[0]

            //this.$ref.musicAudio.play()
            //console.log(this.songsInfo);

            //求歌曲的歌词信息
            $.get({
              url: '/lyric',
              data: { id: id },
              success: (res) => {
                this.songsLrc = res['lrc'].lyric.split('\n');
               
                this.songsLrc.forEach((ele, i, array) => {
                  var obj = {};
                  var a = ele.split(']');
                  obj.time = timeCycle(a[0]);
                  obj.lrc = '';
                  obj.curIndex = i;
                  array[i] = obj;
                })
                console.log(this.songsLrc);

                //把传进的时间转为毫秒
                function timeCycle(obj) {
                  var hao = obj.slice(7) * 1;
                  var miao = obj.slice(4, 6) * 1000;
                  var fen = obj.slice(1, 3) * 60000;
                  // console.log('毫秒:'+hao)
                  // console.log('秒:'+miao)
                  // console.log('分:'+fen)
                  var time = hao + fen + miao;
                  // console.log(time);
                  return time;
                }
              }
            })
          })
        },

        //audio播放进度发生改变时
        audio() {
          //var time = Math.floor(this.$refs.musicAudio.currentTime * 1000)
          this.audioTime = this.$refs.musicAudio.currentTime * 1000;
          // console.log(this.songsLrc);
          if (this.songsLrc && this.songsLrc.length > 0) {

            var res = this.songsLrc.find(function (ele, i, array) {
              //console.log("进度条时间:" + this.audioTime);
              // console.log("音乐的时间:" + ele.time);
              // console.log("正确的时间:" + (ele.time + (array[i+1].time - ele.time)));
              // console.log(array[i+1].time);
              // console.log("当前歌词的时间:" + (array[i+1].time - ele.time))
              return this.audioTime < (ele.time + (array[i + 1].time - ele.time))

            }.bind(this))
              //console.log(res.curIndex);
              this.currentLrc.lrc = res.lrc;
              this.currentLrc.index = res.curIndex;
          }
        },

        tabPage(page) {
          //如果是第一页和最后一页就不执行
          if (page > this.songCountPage || page < 1) return;

          this.currentPage = page
          $.get('/search', { keywords: this.searchKeyword, limit: this.limit, offset: (this.currentPage - 1) * this.limit }, function (res) {

            this.songs = res.result.songs
            this.songCountPage = Math.ceil(res.result.songCount / this.limit);
            // console.log(res);
            // console.log(this.songCountPage);
          }.bind(this))
        }
      }
    }
  )
</script>

</html>